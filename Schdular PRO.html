<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global LinkedIn Scheduler (Master)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            height: 12px;
            width: 12px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e2e8f0; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 6px;
            border: 3px solid #e2e8f0;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Card Styles */
        .card-amer { border-top: 4px solid #10b981; background: white; }
        .card-eu   { border-top: 4px solid #3b82f6; background: white; }
        .card-mea  { border-top: 4px solid #a855f7; background: white; }
        .card-apac { border-top: 4px solid #f97316; background: white; }

        .tag-amer { background: #ecfdf5; color: #047857; }
        .tag-eu   { background: #eff6ff; color: #1d4ed8; }
        .tag-mea  { background: #faf5ff; color: #7e22ce; }
        .tag-apac { background: #fff7ed; color: #c2410c; }

        .active-glow {
            box-shadow: 0 0 0 2px #3b82f6, 0 4px 6px -1px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            transition: all 0.3s ease;
            z-index: 20;
        }

        /* Alarm Animation */
        @keyframes bell-shake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            100% { transform: rotate(0); }
        }
        .bell-active {
            color: #3b82f6;
            animation: bell-shake 2s infinite; 
        }
        .bell-btn:hover {
            background-color: #f1f5f9;
        }

        /* Toast Notification */
        #alarm-toast {
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #alarm-toast.show {
            transform: translateY(0);
        }
        
        /* Note Field Styles */
        .note-field {
            transition: all 0.2s;
        }
        .note-field:focus {
            background-color: #fefce8; /* Yellow-50 */
            border-color: #fde047; /* Yellow-300 */
        }

        /* Time Input Styles */
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 z-30 flex-none shadow-sm">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-[#0077b5] text-white p-2 rounded-lg shadow-sm">
                        <i class="fab fa-linkedin fa-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-slate-800 tracking-tight">Global Scheduler <span class="text-[#0077b5]">Master</span></h1>
                        <p class="text-xs text-slate-500 font-medium">Synced to Indian Standard Time (IST)</p>
                    </div>
                </div>

                <!-- Live Clock -->
                <div class="flex flex-col items-end bg-slate-50 px-3 py-1.5 rounded-md border border-slate-100 min-w-[120px]">
                    <div class="text-xl font-mono font-bold text-[#0077b5] leading-none" id="live-clock">--:--:-- PM</div>
                    <div class="text-[10px] text-slate-400 font-semibold uppercase tracking-wider mt-1" id="live-date">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Controls -->
    <div class="bg-white border-b border-slate-200 px-6 py-2 flex-none z-20 shadow-sm">
        <div class="flex flex-col gap-2">
            
            <!-- Region Filters -->
            <div class="flex gap-2 text-sm overflow-x-auto w-full scrollbar-hide items-center">
                <span class="text-slate-400 font-bold text-[10px] uppercase tracking-wider self-center mr-2 flex-none">Region:</span>
                <button onclick="updateRegionFilter('all')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-800 text-white hover:bg-slate-700 transition shadow-sm whitespace-nowrap active" data-region="all">All Regions</button>
                <button onclick="updateRegionFilter('apac')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-white border border-orange-200 text-orange-600 hover:bg-orange-50 transition whitespace-nowrap" data-region="apac">üåè APAC</button>
                <button onclick="updateRegionFilter('mea')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-white border border-purple-200 text-purple-600 hover:bg-purple-50 transition whitespace-nowrap" data-region="mea">üåç MEA</button>
                <button onclick="updateRegionFilter('eu')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-white border border-blue-200 text-blue-600 hover:bg-blue-50 transition whitespace-nowrap" data-region="eu">üá™üá∫ Europe</button>
                <button onclick="updateRegionFilter('amer')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-white border border-green-200 text-green-600 hover:bg-green-50 transition whitespace-nowrap" data-region="amer">üåé Americas</button>
            </div>

            <!-- Time Filters -->
            <div class="flex gap-2 text-sm overflow-x-auto w-full scrollbar-hide items-center border-t border-slate-100 pt-2 flex-wrap sm:flex-nowrap">
                 <span class="text-slate-400 font-bold text-[10px] uppercase tracking-wider self-center mr-2 flex-none">Time Filter:</span>
                 
                 <div class="flex items-center gap-4">
                     <!-- Active Now Button -->
                     <button onclick="toggleActiveOnly()" id="btn-active-now" class="flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-white border border-green-200 text-green-600 hover:bg-green-50 transition shadow-sm whitespace-nowrap">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        Active Now
                     </button>

                     <div class="h-4 w-px bg-slate-200"></div>

                     <!-- Manual Range -->
                     <div class="flex items-center gap-2 bg-white rounded-full border border-slate-200 px-3 py-1 shadow-sm">
                        <input type="time" id="filter-start" class="text-xs text-slate-600 focus:outline-none font-medium bg-transparent cursor-pointer" onchange="updateTimeFilter()">
                        <span class="text-slate-400 text-xs font-bold px-1">to</span>
                        <input type="time" id="filter-end" class="text-xs text-slate-600 focus:outline-none font-medium bg-transparent cursor-pointer" onchange="updateTimeFilter()">
                     </div>

                     <button onclick="resetTimeFilter()" class="hidden text-xs text-blue-500 hover:text-blue-700 font-medium px-2 underline" id="reset-time-btn">Reset Time</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <main class="flex-1 overflow-auto custom-scroll bg-[#f8fafc] relative">
        <div class="grid grid-cols-7 min-w-[1600px] divide-x divide-slate-200 border-t border-slate-200" id="scheduler-grid">
            <!-- Grid Content via JS -->
        </div>
    </main>
    
    <!-- Legend Footer -->
    <footer class="bg-white border-t border-slate-200 px-4 py-2 text-[10px] text-slate-500 flex justify-between items-center z-30 relative flex-none">
        <div class="flex gap-4">
            <span class="flex items-center gap-1"><i class="fas fa-star text-amber-400"></i> Primary Window</span>
            <span class="flex items-center gap-1"><i class="fas fa-history text-slate-400"></i> Secondary Window</span>
            <span class="flex items-center gap-1"><i class="fas fa-bell text-blue-500"></i> Alarm On</span>
             <span class="flex items-center gap-1"><i class="fas fa-pen-to-square text-slate-400"></i> Content Plan</span>
        </div>
        <div>
            Times calculated for January (Winter/Summer Split)
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="alarm-toast" class="fixed bottom-4 right-4 bg-white border-l-4 border-blue-500 shadow-xl rounded-md p-4 flex items-start gap-3 z-50 max-w-sm">
        <div class="bg-blue-100 text-blue-600 rounded-full p-2 mt-1">
            <i class="fas fa-bell"></i>
        </div>
        <div>
            <h4 class="font-bold text-slate-800 text-sm">Posting Window Open!</h4>
            <p id="toast-message" class="text-xs text-slate-600 mt-1">New Zealand is now active.</p>
            <button onclick="closeToast()" class="text-[10px] text-slate-400 hover:text-slate-800 underline mt-2">Dismiss</button>
        </div>
    </div>

    <script>
        // MASTER Data Source (22 Regions)
        const regions = [
            // --- APAC (Early Morning IST) ---
            { id: 'nz', name: 'New Zealand', group: 'apac', flag: 'üá≥üáø', days: [2,3], start: '00:00', end: '01:00', localStart: '07:30', localEnd: '08:30', secStart: '04:30', secEnd: '05:30', secLocalStart: '12:00', secLocalEnd: '13:00' },
            { id: 'syd', name: 'Sydney (Australia)', group: 'apac', flag: 'üá¶üá∫', days: [3,4], start: '02:00', end: '03:30', localStart: '07:30', localEnd: '09:00', secStart: '07:00', secEnd: '08:30', secLocalStart: '12:30', secLocalEnd: '14:00' },
            { id: 'jp', name: 'Tokyo (Japan)', group: 'apac', flag: 'üáØüáµ', days: [2,3,4], start: '04:30', end: '06:00', localStart: '08:00', localEnd: '09:30', secStart: '13:30', secEnd: '14:30', secLocalStart: '17:00', secLocalEnd: '18:00' },
            { id: 'per', name: 'Perth (Australia)', group: 'apac', flag: 'üá¶üá∫', days: [2,3,4], start: '05:00', end: '06:30', localStart: '07:30', localEnd: '09:00', secStart: '14:30', secEnd: '15:30', secLocalStart: '17:00', secLocalEnd: '18:00' },
            { id: 'hk', name: 'Hong Kong', group: 'apac', flag: 'üá≠üá∞', days: [2,3,4], start: '06:00', end: '08:00', localStart: '08:30', localEnd: '10:30', secStart: '15:00', secEnd: '16:00', secLocalStart: '17:30', secLocalEnd: '18:30' },
            { id: 'sg', name: 'Singapore', group: 'apac', flag: 'üá∏üá¨', days: [2,3,4], start: '06:00', end: '08:00', localStart: '08:30', localEnd: '10:30', secStart: '15:00', secEnd: '16:00', secLocalStart: '17:30', secLocalEnd: '18:30' },
            { id: 'in', name: 'India (Local)', group: 'apac', flag: 'üáÆüá≥', days: [2,3,4], start: '08:00', end: '10:00', localStart: '08:00', localEnd: '10:00', secStart: '17:00', secEnd: '18:00', secLocalStart: '17:00', secLocalEnd: '18:00' },

            // --- MEA (Morning/Noon IST) ---
            { id: 'uae', name: 'Dubai (UAE)', group: 'mea', flag: 'üá¶üá™', days: [1,2,3], start: '09:30', end: '11:30', localStart: '08:00', localEnd: '10:00', secStart: '19:30', secEnd: '21:30', secLocalStart: '18:00', secLocalEnd: '20:00' },
            { id: 'ru', name: 'Moscow (Russia)', group: 'eu', flag: 'üá∑üá∫', days: [2,3], start: '10:30', end: '12:30', localStart: '08:00', localEnd: '10:00', secStart: '19:30', secEnd: '20:30', secLocalStart: '17:00', secLocalEnd: '18:00' },
            { id: 'ng', name: 'Lagos (Nigeria)', group: 'mea', flag: 'üá≥üá¨', days: [2,3,4], start: '12:30', end: '14:30', localStart: '08:00', localEnd: '10:00', secStart: '20:30', secEnd: '21:30', secLocalStart: '16:00', secLocalEnd: '17:00' },
            { id: 'sa', name: 'South Africa', group: 'mea', flag: 'üáøüá¶', days: [2,3,4], start: '11:30', end: '13:30', localStart: '08:00', localEnd: '10:00', secStart: '19:30', secEnd: '20:30', secLocalStart: '16:00', secLocalEnd: '17:00' },
            { id: 'rw', name: 'Rwanda', group: 'mea', flag: 'üá∑üáº', days: [2,3], start: '12:30', end: '14:30', localStart: '09:00', localEnd: '11:00', secStart: '17:30', secEnd: '18:30', secLocalStart: '14:00', secLocalEnd: '15:00' },

            // --- Europe (Afternoon IST) ---
            { id: 'de', name: 'Germany', group: 'eu', flag: 'üá©üá™', days: [2,3,4], start: '12:30', end: '14:00', localStart: '08:00', localEnd: '09:30', secStart: '16:30', secEnd: '18:00', secLocalStart: '12:00', secLocalEnd: '13:30' },
            { id: 'fr', name: 'Paris (France)', group: 'eu', flag: 'üá´üá∑', days: [2,3,4], start: '12:30', end: '14:00', localStart: '08:00', localEnd: '09:30', secStart: '16:30', secEnd: '18:00', secLocalStart: '12:00', secLocalEnd: '13:30' },
            { id: 'nl', name: 'Amsterdam (NL)', group: 'eu', flag: 'üá≥üá±', days: [2,3,4], start: '12:30', end: '14:00', localStart: '08:00', localEnd: '09:30', secStart: '16:30', secEnd: '18:00', secLocalStart: '12:00', secLocalEnd: '13:30' },
            { id: 'pl', name: 'Poland', group: 'eu', flag: 'üáµüá±', days: [2,3,4], start: '13:30', end: '15:30', localStart: '09:00', localEnd: '11:00', secStart: '17:30', secEnd: '18:30', secLocalStart: '13:00', secLocalEnd: '14:00' },
            { id: 'uk', name: 'London (UK)', group: 'eu', flag: 'üá¨üáß', days: [2,3,4], start: '14:00', end: '15:30', localStart: '08:30', localEnd: '10:00', secStart: '18:30', secEnd: '19:30', secLocalStart: '13:00', secLocalEnd: '14:00' },

            // --- Americas (Evening/Night IST) ---
            { id: 'br', name: 'Brasilia (Brazil)', group: 'amer', flag: 'üáßüá∑', days: [2,3], start: '17:30', end: '19:30', localStart: '09:00', localEnd: '11:00', secStart: '01:30', secEnd: '02:30', secLocalStart: '17:00', secLocalEnd: '18:00' },
            { id: 'ny', name: 'New York (USA)', group: 'amer', flag: 'üá∫üá∏', days: [2,3,4], start: '18:30', end: '20:30', localStart: '08:00', localEnd: '10:00', secStart: '22:30', secEnd: '23:30', secLocalStart: '12:00', secLocalEnd: '13:00' },
            { id: 'to', name: 'Toronto (Canada)', group: 'amer', flag: 'üá®üá¶', days: [2,3,4], start: '18:30', end: '20:30', localStart: '08:00', localEnd: '10:00', secStart: '22:00', secEnd: '23:00', secLocalStart: '11:30', secLocalEnd: '12:30' },
            { id: 'van', name: 'Vancouver (Canada)', group: 'amer', flag: 'üá®üá¶', days: [2,3,4], start: '21:15', end: '22:30', localStart: '07:45', localEnd: '09:00', secStart: '01:30', secEnd: '02:30', secLocalStart: '12:00', secLocalEnd: '13:00' },
            { id: 'sf', name: 'San Francisco (USA)', group: 'amer', flag: 'üá∫üá∏', days: [2,3,4], start: '21:30', end: '23:30', localStart: '08:00', localEnd: '10:00', secStart: '01:30', secEnd: '02:30', secLocalStart: '12:00', secLocalEnd: '13:00' }
        ];

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        // Global Filter State
        let activeRegion = 'all';
        let filterStartMin = null; 
        let filterEndMin = null;   
        let activeOnlyFilter = false;

        // Stores unique identifiers for enabled alarms: "regionID-dayIndex"
        let activeAlarms = new Set();
        // Stores alarms that have already rung this session so they don't ring every second
        let triggeredAlarms = new Set();

        function init() {
            renderGrid();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(checkAlarms, 10000); // Check every 10 seconds
        }

        function renderGrid() {
            const grid = document.getElementById('scheduler-grid');
            grid.innerHTML = '';

            days.forEach((dayName, index) => {
                const dayIndex = index + 1; // 1-based
                
                const col = document.createElement('div');
                col.className = 'flex flex-col bg-white border-r border-slate-200';

                // Header
                const isWeekend = dayIndex > 5;
                col.innerHTML = `
                    <div class="p-3 border-b border-slate-100 bg-slate-50 sticky top-0 z-10 text-center shadow-sm">
                        <div class="text-xs font-bold uppercase tracking-widest ${isWeekend ? 'text-red-400' : 'text-slate-600'}">${dayName}</div>
                    </div>
                `;

                // Body
                const body = document.createElement('div');
                body.className = 'flex-1 p-2 space-y-3 pb-12';

                const dayEvents = regions.filter(r => r.days.includes(dayIndex));
                dayEvents.sort((a, b) => parseInt(a.start.replace(':', '')) - parseInt(b.start.replace(':', '')));

                if (dayEvents.length === 0) {
                    body.innerHTML = `<div class="mt-8 text-center"><div class="text-slate-200 text-3xl mb-2"><i class="fas fa-coffee"></i></div><div class="text-[10px] text-slate-400 font-medium">No peak times</div></div>`;
                } else {
                    dayEvents.forEach(event => {
                        body.appendChild(createCard(event, dayIndex));
                    });
                }

                col.appendChild(body);
                grid.appendChild(col);
            });
            
            highlightActiveSlots();
        }

        // Helper to get saved note from local storage
        function getSavedNote(id) {
            return localStorage.getItem('linkedin_note_' + id) || '';
        }

        // Helper to save note to local storage
        function saveNote(id, value) {
            localStorage.setItem('linkedin_note_' + id, value);
        }

        function createCard(event, dayIndex) {
            const card = document.createElement('div');
            // Unique ID for alarm tracking AND notes: regionID + dayIndex
            const uniqueId = `${event.id}-${dayIndex}`;
            
            card.dataset.start = event.start;
            card.dataset.end = event.end;
            card.dataset.secStart = event.secStart;
            card.dataset.secEnd = event.secEnd;
            card.dataset.group = event.group;
            card.dataset.uniqueId = uniqueId;
            card.dataset.regionName = event.name;
            
            // Added grid-card class for easier selection
            card.className = `grid-card rounded-lg shadow-sm hover:shadow-md transition-all border border-slate-100 overflow-hidden card-${event.group} relative`;
            
            const isAlarmActive = activeAlarms.has(uniqueId);
            const savedNote = getSavedNote(uniqueId);
            
            const regionShortName = event.name.split('(')[0].trim();

            card.innerHTML = `
                <div class="px-3 py-2">
                    <!-- Title & Alarm -->
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-800 text-xs flex items-center gap-1.5 truncate">
                            ${event.flag} ${event.name}
                        </span>
                        <div class="flex items-center gap-2">
                             <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-full tag-${event.group} uppercase tracking-wide">
                                ${event.group}
                            </span>
                            <button onclick="toggleAlarm('${uniqueId}', this)" class="bell-btn p-1 rounded-full transition-colors ${isAlarmActive ? 'text-blue-500' : 'text-slate-300'}" title="Toggle Alarm">
                                <i class="${isAlarmActive ? 'fas' : 'far'} fa-bell text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Primary Window -->
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-star text-[10px] text-amber-400"></i>
                                <span class="text-[10px] font-bold text-slate-700 uppercase">Primary Window</span>
                            </div>
                            <!-- LIVE Badge for Primary -->
                            <div id="primary-live-${uniqueId}" class="hidden text-[8px] font-bold text-green-600 bg-green-100 px-1.5 py-0.5 rounded animate-pulse">LIVE</div>
                        </div>
                        <div class="bg-slate-50 rounded-md p-2 border border-slate-200 transition-colors" id="primary-box-${uniqueId}">
                            <!-- India Time Section -->
                            <div class="mb-1.5">
                                 <div class="text-[9px] font-bold text-blue-600 uppercase tracking-wide flex items-center gap-1">
                                    <i class="fas fa-clock"></i> Post Time (India/IST)
                                 </div>
                                 <div class="font-bold text-slate-800 text-sm mt-0.5">
                                    ${convertTo12Hour(event.start)} - ${convertTo12Hour(event.end)}
                                 </div>
                            </div>
                            <!-- Region Time Section -->
                            <div class="pt-1.5 border-t border-slate-200">
                                 <div class="text-[9px] font-medium text-slate-500 uppercase tracking-wide flex items-center gap-1">
                                    <i class="fas fa-globe"></i> Region Time (${regionShortName})
                                 </div>
                                 <div class="text-xs text-slate-600 font-medium mt-0.5">
                                    ${convertTo12Hour(event.localStart)} - ${convertTo12Hour(event.localEnd)}
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Window -->
                    <div class="mb-2">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-history text-[10px] text-slate-400"></i>
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Secondary Window</span>
                            </div>
                             <!-- LIVE Badge for Secondary -->
                            <div id="secondary-live-${uniqueId}" class="hidden text-[8px] font-bold text-green-600 bg-green-100 px-1.5 py-0.5 rounded animate-pulse">LIVE</div>
                        </div>
                        <div class="bg-white rounded-md p-2 border border-slate-100 border-dashed transition-colors" id="secondary-box-${uniqueId}">
                             <!-- India Time Section -->
                            <div class="mb-1.5">
                                 <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wide">
                                    Post Time (India/IST)
                                 </div>
                                 <div class="font-medium text-slate-600 text-xs mt-0.5">
                                    ${convertTo12Hour(event.secStart)} - ${convertTo12Hour(event.secEnd)}
                                 </div>
                            </div>
                            <!-- Region Time Section -->
                            <div class="pt-1.5 border-t border-slate-100">
                                 <div class="text-[9px] font-medium text-slate-300 uppercase tracking-wide">
                                    Region Time (${regionShortName})
                                 </div>
                                 <div class="text-xs text-slate-400 font-medium mt-0.5">
                                    ${convertTo12Hour(event.secLocalStart)} - ${convertTo12Hour(event.secLocalEnd)}
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Note -->
                    <div class="pt-2 border-t border-slate-100/60">
                         <div class="flex items-center gap-1 mb-1">
                            <i class="fas fa-pen-to-square text-[9px] text-slate-400"></i>
                            <span class="text-[9px] font-bold text-slate-400 uppercase">Post Topic</span>
                        </div>
                        <textarea 
                            class="note-field w-full text-[10px] p-1.5 bg-yellow-50/50 border border-yellow-100 rounded text-slate-600 focus:outline-none focus:bg-yellow-50 focus:border-yellow-300 resize-none placeholder-slate-300"
                            rows="2" 
                            placeholder="e.g. Python Intro..."
                            oninput="saveNote('${uniqueId}', this.value)"
                        >${savedNote}</textarea>
                    </div>
                </div>
                <!-- Action Badge Placeholder -->
                <div class="status-bar hidden bg-blue-500 text-white text-[9px] font-bold text-center py-1 tracking-wider uppercase animate-pulse">
                    Active Now
                </div>
            `;
            return card;
        }

        // Updated for 12-Hour format for Text Labels
        function convertTo12Hour(time24) {
            const [hours, minutes] = time24.split(':');
            let h = parseInt(hours);
            const m = minutes;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; 
            return `${h}:${m}<span class="text-[8px] opacity-70 ml-px">${ampm}</span>`;
        }

        // Updated for 12-Hour format for LIVE CLOCK
        function updateTime() {
            const now = new Date();
            // Changed hour12 to TRUE
            document.getElementById('live-clock').textContent = now.toLocaleTimeString('en-US', { hour12: true });
            document.getElementById('live-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) + " (IST)";
        }

        function highlightActiveSlots() {
            const now = new Date();
            let currentDay = now.getDay(); 
            if (currentDay === 0) currentDay = 7; 

            const currentVal = now.getHours() * 60 + now.getMinutes();
            const cards = document.querySelectorAll('[data-start]');

            cards.forEach(card => {
                const col = card.closest('.flex-col');
                const colIndex = Array.from(col.parentNode.children).indexOf(col) + 1;
                const statusBar = card.querySelector('.status-bar');

                if (colIndex === currentDay) {
                    const isPrimary = isTimeInRange(currentVal, card.dataset.start, card.dataset.end);
                    const isSecondary = isTimeInRange(currentVal, card.dataset.secStart, card.dataset.secEnd);

                    if (isPrimary || isSecondary) {
                        card.classList.add('active-glow');
                        card.classList.remove('border-slate-100');
                        card.classList.add('border-blue-400');
                        statusBar.classList.remove('hidden');
                    } else {
                        resetCard(card, statusBar);
                    }
                    
                    // Highlight specific windows
                    const uniqueId = card.dataset.uniqueId;
                    const primaryBox = document.getElementById(`primary-box-${uniqueId}`);
                    const primaryLive = document.getElementById(`primary-live-${uniqueId}`);
                    const secondaryBox = document.getElementById(`secondary-box-${uniqueId}`);
                    const secondaryLive = document.getElementById(`secondary-live-${uniqueId}`);

                    // Toggle Primary
                    if (isPrimary) {
                        primaryBox.classList.remove('bg-slate-50', 'border-slate-200');
                        primaryBox.classList.add('bg-green-50', 'border-green-400');
                        primaryLive.classList.remove('hidden');
                    } else {
                        primaryBox.classList.add('bg-slate-50', 'border-slate-200');
                        primaryBox.classList.remove('bg-green-50', 'border-green-400');
                        primaryLive.classList.add('hidden');
                    }
                    
                    // Toggle Secondary
                    if (isSecondary) {
                         secondaryBox.classList.remove('bg-white', 'border-slate-100', 'border-dashed');
                         secondaryBox.classList.add('bg-green-50', 'border-green-400', 'border-solid');
                         secondaryLive.classList.remove('hidden');
                    } else {
                         secondaryBox.classList.add('bg-white', 'border-slate-100', 'border-dashed');
                         secondaryBox.classList.remove('bg-green-50', 'border-green-400', 'border-solid');
                         secondaryLive.classList.add('hidden');
                    }
                    
                } else {
                    resetCard(card, statusBar);
                    
                    // Also reset inner boxes if day changes
                    const uniqueId = card.dataset.uniqueId;
                    const primaryBox = document.getElementById(`primary-box-${uniqueId}`);
                    const primaryLive = document.getElementById(`primary-live-${uniqueId}`);
                    const secondaryBox = document.getElementById(`secondary-box-${uniqueId}`);
                    const secondaryLive = document.getElementById(`secondary-live-${uniqueId}`);
                    
                    if(primaryBox) {
                         primaryBox.classList.add('bg-slate-50', 'border-slate-200');
                         primaryBox.classList.remove('bg-green-50', 'border-green-400');
                         primaryLive.classList.add('hidden');
                    }
                    if(secondaryBox) {
                         secondaryBox.classList.add('bg-white', 'border-slate-100', 'border-dashed');
                         secondaryBox.classList.remove('bg-green-50', 'border-green-400', 'border-solid');
                         secondaryLive.classList.add('hidden');
                    }
                }
            });
        }

        function isTimeInRange(currentVal, startStr, endStr) {
            const sVal = parseInt(startStr.split(':')[0]) * 60 + parseInt(startStr.split(':')[1]);
            const eVal = parseInt(endStr.split(':')[0]) * 60 + parseInt(endStr.split(':')[1]);
            
            if (eVal < sVal) { // Crosses midnight
                 return currentVal >= sVal || currentVal <= eVal;
            }
            return currentVal >= sVal && currentVal <= eVal;
        }

        function resetCard(card, statusBar) {
            card.classList.remove('active-glow', 'border-blue-400');
            card.classList.add('border-slate-100');
            statusBar.classList.add('hidden');
        }

        // --- Alarm Logic ---

        function toggleAlarm(uniqueId, btn) {
            const icon = btn.querySelector('i');
            if (activeAlarms.has(uniqueId)) {
                activeAlarms.delete(uniqueId);
                icon.classList.remove('fas', 'bell-active', 'text-blue-500');
                icon.classList.add('far', 'text-slate-300');
                btn.classList.remove('text-blue-500');
                btn.classList.add('text-slate-300');
            } else {
                activeAlarms.add(uniqueId);
                icon.classList.remove('far', 'text-slate-300');
                icon.classList.add('fas', 'bell-active', 'text-blue-500');
                btn.classList.remove('text-slate-300');
                btn.classList.add('text-blue-500');
                
                // Request notification permission if needed (best effort)
                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            }
        }

        function checkAlarms() {
            const now = new Date();
            let currentDay = now.getDay(); 
            if (currentDay === 0) currentDay = 7; 
            const currentVal = now.getHours() * 60 + now.getMinutes();

            activeAlarms.forEach(uniqueId => {
                const card = document.querySelector(`[data-unique-id="${uniqueId}"]`);
                // Only check if card exists (it should)
                if (card) {
                     // Check if TODAY is the day for this alarm
                    const col = card.closest('.flex-col');
                    const colIndex = Array.from(col.parentNode.children).indexOf(col) + 1;

                    if (colIndex === currentDay) {
                         const isActive = isTimeInRange(currentVal, card.dataset.start, card.dataset.end) || 
                                          isTimeInRange(currentVal, card.dataset.secStart, card.dataset.secEnd);
                        
                        // If active AND hasn't rung yet
                        if (isActive && !triggeredAlarms.has(uniqueId)) {
                            triggerAlarmEffect(card.dataset.regionName);
                            triggeredAlarms.add(uniqueId);
                        }
                        // Reset trigger if window passed (so it can ring again next week)
                        if (!isActive && triggeredAlarms.has(uniqueId)) {
                            triggeredAlarms.delete(uniqueId);
                        }
                    }
                }
            });
        }

        function triggerAlarmEffect(regionName) {
            playBeep();
            showToast(regionName);
            
            // Try System Notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("LinkedIn Scheduler", {
                    body: `Time to post for ${regionName}!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/174/174857.png"
                });
            }
        }

        function showToast(regionName) {
            const toast = document.getElementById('alarm-toast');
            document.getElementById('toast-message').textContent = `${regionName} is now active.`;
            toast.classList.add('show');
            setTimeout(() => {
                closeToast();
            }, 8000);
        }

        function closeToast() {
            document.getElementById('alarm-toast').classList.remove('show');
        }

        // Simple Beep using Web Audio API (No external files needed)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); // Slide to A5
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        // --- Filtering Logic ---

        function updateRegionFilter(value) {
            activeRegion = value;
            // Update Region Buttons UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.region === value) {
                    btn.classList.add('bg-slate-800', 'text-white');
                    btn.classList.remove('bg-white', 'text-slate-600', 'text-orange-600', 'text-purple-600', 'text-blue-600', 'text-green-600');
                } else {
                    btn.classList.remove('bg-slate-800', 'text-white');
                    btn.classList.add('bg-white');
                    if(btn.dataset.region === 'apac') btn.classList.add('text-orange-600');
                    else if(btn.dataset.region === 'mea') btn.classList.add('text-purple-600');
                    else if(btn.dataset.region === 'eu') btn.classList.add('text-blue-600');
                    else if(btn.dataset.region === 'amer') btn.classList.add('text-green-600');
                    else btn.classList.add('text-slate-600');
                }
            });
            applyFilters();
        }

        function toggleActiveOnly() {
            activeOnlyFilter = !activeOnlyFilter;
            
            const btn = document.getElementById('btn-active-now');
            if (activeOnlyFilter) {
                btn.classList.add('bg-green-600', 'text-white', 'border-green-600');
                btn.classList.remove('bg-white', 'text-green-600', 'border-green-200');
                
                // Clear manual inputs
                document.getElementById('filter-start').value = '';
                document.getElementById('filter-end').value = '';
                filterStartMin = null;
                filterEndMin = null;
                document.getElementById('reset-time-btn').classList.add('hidden');
            } else {
                btn.classList.remove('bg-green-600', 'text-white', 'border-green-600');
                btn.classList.add('bg-white', 'text-green-600', 'border-green-200');
            }
            applyFilters();
        }

        function updateTimeFilter() {
            const startVal = document.getElementById('filter-start').value;
            const endVal = document.getElementById('filter-end').value;

            const resetBtn = document.getElementById('reset-time-btn');

            if (startVal && endVal) {
                // Deactivate "Active Now"
                if (activeOnlyFilter) toggleActiveOnly(); 

                // Parse to minutes
                filterStartMin = parseInt(startVal.split(':')[0]) * 60 + parseInt(startVal.split(':')[1]);
                filterEndMin = parseInt(endVal.split(':')[0]) * 60 + parseInt(endVal.split(':')[1]);
                resetBtn.classList.remove('hidden');
                applyFilters();
            } else {
                filterStartMin = null;
                filterEndMin = null;
                resetBtn.classList.add('hidden');
                applyFilters(); // Re-apply to clear if only one was selected then cleared
            }
        }

        function resetTimeFilter() {
            document.getElementById('filter-start').value = '';
            document.getElementById('filter-end').value = '';
            updateTimeFilter();
        }

        function applyFilters() {
            const cards = document.querySelectorAll('.grid-card');
            
            cards.forEach(card => {
                const matchesRegion = activeRegion === 'all' || card.dataset.group === activeRegion;
                
                let matchesTime = true;
                
                // Manual Time Window Logic
                if (filterStartMin !== null && filterEndMin !== null) {
                    const checkOverlap = (rangeStart, rangeEnd, filterStart, filterEnd) => {
                        if (rangeEnd < rangeStart) {
                             return (rangeStart < filterEnd) || (0 < filterEnd && rangeEnd > filterStart); 
                        }
                        return Math.max(rangeStart, filterStart) < Math.min(rangeEnd, filterEnd);
                    };

                    const pStart = parseInt(card.dataset.start.split(':')[0]) * 60 + parseInt(card.dataset.start.split(':')[1]);
                    const pEnd = parseInt(card.dataset.end.split(':')[0]) * 60 + parseInt(card.dataset.end.split(':')[1]);
                    const sStart = parseInt(card.dataset.secStart.split(':')[0]) * 60 + parseInt(card.dataset.secStart.split(':')[1]);
                    const sEnd = parseInt(card.dataset.secEnd.split(':')[0]) * 60 + parseInt(card.dataset.secEnd.split(':')[1]);

                    const primaryOverlap = checkOverlap(pStart, pEnd, filterStartMin, filterEndMin);
                    const secondaryOverlap = checkOverlap(sStart, sEnd, filterStartMin, filterEndMin);

                    matchesTime = primaryOverlap || secondaryOverlap;
                }
                
                // Active Now Logic
                else if (activeOnlyFilter) {
                     const now = new Date();
                     let currentDay = now.getDay();
                     if (currentDay === 0) currentDay = 7;
                     const currentVal = now.getHours() * 60 + now.getMinutes();
                     
                     // Get day column index
                     const col = card.closest('.flex-col');
                     const colIndex = Array.from(col.parentNode.children).indexOf(col) + 1;
                     
                     const isToday = colIndex === currentDay;
                     const isTime = isTimeInRange(currentVal, card.dataset.start, card.dataset.end) || 
                                    isTimeInRange(currentVal, card.dataset.secStart, card.dataset.secEnd);
                     
                     matchesTime = isToday && isTime;
                }

                if (matchesRegion && matchesTime) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        init();
    </script>
</body>
</html>